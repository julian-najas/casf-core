# casf-core

[![CI](https://github.com/julian-najas/casf-core/actions/workflows/ci.yml/badge.svg)](https://github.com/julian-najas/casf-core/actions/workflows/ci.yml)
[![mypy: strict](https://img.shields.io/badge/mypy-strict-blue.svg)](https://mypy.readthedocs.io/)
[![code style: ruff](https://img.shields.io/badge/code%20style-ruff-000000.svg)](https://docs.astral.sh/ruff/)
[![license: Apache-2.0](https://img.shields.io/badge/license-Apache--2.0-green.svg)](LICENSE)

> **Public by design** — This repository is public for demo / portfolio purposes.
> It contains **no secrets, credentials, or PHI**. Production configurations live in private infrastructure.

Zero-trust verification gateway for PHI/PII automation.
Validates intent (tool / role / mode) before any execution, enforces policy via OPA, applies rate limiting, and writes an append-only hash-chained audit trail.

## Architecture

```
  request ──► Verifier ──► OPA (Rego)
                │
        ┌───────┼───────┐
      Redis   Postgres  Audit
    (rate-limit) (DDL)  (hash-chain)
```

| Component | Purpose |
|-----------|---------|
| **Verifier** (FastAPI) | Hard invariants, rate limiting, OPA consultation, audit |
| **OPA** (Rego) | External policy engine — deny-by-default governance |
| **Redis** | Atomic rate limiting (Lua + TTL), fail-closed on writes |
| **Postgres** | Append-only audit trail with SHA-256 hash chain |

## Quick start

```bash
# Start the full stack
docker compose -f deploy/compose/docker-compose.yml up --build -d

# Verify all services are healthy
docker compose -f deploy/compose/docker-compose.yml ps

# Run tests (from services/verifier with Python 3.11 venv)
cd services/verifier
pip install -e ".[dev]"
pytest -v

# Run OPA policy tests
docker run --rm -v "$PWD/policies:/policies:ro" \
  openpolicyagent/opa:0.63.0 test /policies -v

# Smoke test (PowerShell)
.\deploy\compose\scripts\smoke_pr3.ps1
```

## Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/verify` | Decision endpoint — validates and returns ALLOW / DENY / NEEDS_APPROVAL |
| `GET` | `/health` | Liveness probe (process alive) |
| `GET` | `/healthz` | Readiness probe (Postgres + Redis + OPA reachable) |
| `GET` | `/metrics` | Prometheus text exposition |
| `GET` | `/openapi.json` | OpenAPI 3.1 schema (auto-generated by FastAPI) |

Verifier listens on port **8000** (container) → **8088** (host).

## OpenAPI & SDK generation

The OpenAPI 3.1 schema is exported to `contracts/openapi.json` and checked
in CI for drift. Generate a type-safe client in any language:

```bash
make openapi          # export schema
make sdk              # generate Python SDK (openapi-python-client)
```

See **[docs/sdk-generation.md](docs/sdk-generation.md)** for TypeScript, Go,
Java, Kotlin, and C# examples.

## Benchmarks

```bash
make bench            # 20 users, 30 s headless Locust run
```

See **[docs/benchmarks.md](docs/benchmarks.md)** for scenario details,
baseline targets (p50 < 15 ms, p95 < 50 ms, > 200 req/s), and CI integration.

## Rate limiting

- `twilio.send_sms` → max **1 SMS per `patient_id` per hour** (Redis Lua atomic)
- Redis unavailable → **FAIL_CLOSED** (DENY for all writes)
- Other tools are not rate-limited in v1

## Anti-replay

Every `request_id` is tracked via Redis `SET NX EX` (24 h TTL).
A repeated `request_id` within the window returns **409 Conflict**.

- Redis unavailable → **FAIL_CLOSED** for writes, pass-through for reads
- Clients must generate a new `request_id` per logical request

## Audit digest (anchor-ready)

```bash
# Export yesterday's audit digest (requires PG_DSN)
python -m verifier.export_audit_digest            # → stdout JSON
python -m verifier.export_audit_digest 2026-02-09  # specific date

# Sign and store in WORM / SIEM / S3 Object Lock
python -m verifier.export_audit_digest | gpg --clearsign > digest.asc
```

The digest contains `first_hash`, `last_hash`, `event_count`, `chain_valid`
and a `digest_hash` (SHA-256 of the canonical digest payload).

## Guarantees

- Deny-by-default policy enforcement (OPA)
- Fail-closed on write operations when dependencies are unavailable
- Anti-replay: duplicate `request_id` rejected (409) within 24 h window
- Append-only audit log with SHA-256 hash chain (tamper-evident)
- Anchor-ready digest export for WORM / SIEM verification
- Advisory lock serialisation for concurrent audit writes
- Semantic healthchecks (Postgres SELECT 1, Redis PING, OPA policy eval)

## Non-goals

- No automatic retries or self-healing
- No policy latching
- No business-level authorization logic
- No SLA or high-availability guarantees

## Security

Supply-chain hardening is enforced in CI: SHA-pinned Actions, `pip-audit`,
Gitleaks secrets scan, Trivy container image scan, and CycloneDX SBOM generation.
Dependabot monitors pip, GitHub Actions, and Docker dependencies weekly.

- **[Security policy](SECURITY.md)** — vulnerability reporting and coordinated disclosure.
- **[Threat model](docs/threat-model.md)** — T1 (replay) through T5 (dependency compromise).

## Project structure

```
benchmarks/         # Locust performance test suite
contracts/          # JSON/OpenAPI schemas + enum definitions (versioned)
docs/adr/           # Architecture Decision Records
policies/           # OPA Rego policies (single source of truth)
scripts/            # Automation (export_openapi.py)
services/verifier/  # Python FastAPI service
deploy/compose/     # Docker Compose stack + smoke scripts
deploy/sql/         # Postgres DDL (init.sql)
```

## Release status

**CASF-core is scope-frozen.**

This repository is considered feature-complete for its intended role as a
zero-trust execution gateway.

No new features will be accepted. Only:
- critical bug fixes
- security patches
- documentation corrections

Any extension (modes latching, alerting, reporting, orchestration)
belongs to a separate project or layer.

## License

[Apache-2.0](LICENSE)
